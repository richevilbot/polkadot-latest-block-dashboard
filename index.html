<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Polkadot Latest Block Dashboard</title>
  <style>
    :root { --bg:#0b1020; --panel:#131b38; --text:#e9eeff; --muted:#9aa8cc; --line:#2a3561; --accent:#7fb3ff; }
    html[data-theme='light'] { --bg:#f6f8ff; --panel:#fff; --text:#18213f; --muted:#5d6b93; --line:#d6def7; --accent:#295ce6; }
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1040px;margin:0 auto;padding:20px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin-top:12px}
    .muted{color:var(--muted)}
    button{background:var(--panel);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 12px;cursor:pointer}
    table{width:100%;border-collapse:collapse;font-size:.92rem}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--line);font-size:.8rem}
    .ok{color:#5fe08a}.bad{color:#ff8b8b}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="top">
      <div>
        <h1 style="margin:0">Polkadot Latest Block</h1>
        <div class="muted">Updates every 30s • countdown: <span id="countdown">30</span>s</div>
      </div>
      <button id="themeBtn">Toggle Light/Dark</button>
    </div>

    <section class="card">
      <div class="muted">Latest Finalized Block</div>
      <h2 id="blockNumber" style="margin:6px 0">-</h2>
      <div>Hash: <span id="blockHash" class="muted">-</span></div>
      <div>Parent: <span id="parentHash" class="muted">-</span></div>
      <div>Time: <span id="updated" class="muted">-</span></div>
      <div>Status: <span id="status" class="muted">Connecting...</span></div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h3 style="margin:0">Extrinsics in Latest Block</h3>
        <span id="txCount" class="pill">0 items</span>
      </div>
      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead><tr><th>#</th><th>Pallet</th><th>Method</th><th>Signer</th><th>Success</th></tr></thead>
          <tbody id="rows"><tr><td colspan="5" class="muted">Loading…</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { ApiPromise, WsProvider } from 'https://cdn.jsdelivr.net/npm/@polkadot/api@13.5.7/+esm';

    const cdEl = document.getElementById('countdown');
    const statusEl = document.getElementById('status');
    let left = 30;
    let api;

    function short(v){ return v ? `${v.slice(0,16)}…${v.slice(-8)}` : '-'; }

    async function connect() {
      if (api) return api;
      const provider = new WsProvider('wss://rpc.polkadot.io');
      api = await ApiPromise.create({ provider });
      await api.isReady;
      statusEl.textContent = 'Connected';
      return api;
    }

    function findExtrinsicResult(events, extrinsicIndex) {
      const related = events.filter(({ phase }) => phase.isApplyExtrinsic && phase.asApplyExtrinsic.toNumber() === extrinsicIndex);
      const success = related.some(({ event }) => event.section === 'system' && event.method === 'ExtrinsicSuccess');
      const failed = related.some(({ event }) => event.section === 'system' && event.method === 'ExtrinsicFailed');
      if (success) return '<span class="ok">yes</span>';
      if (failed) return '<span class="bad">no</span>';
      return 'unknown';
    }

    async function fetchLatest() {
      const chain = await connect();
      const hash = await chain.rpc.chain.getFinalizedHead();
      const signedBlock = await chain.rpc.chain.getBlock(hash);
      const at = await chain.at(hash);
      const allEvents = await at.query.system.events();

      const header = signedBlock.block.header;
      const blockNo = header.number.toNumber();
      document.getElementById('blockNumber').textContent = `#${blockNo}`;
      document.getElementById('blockHash').textContent = hash.toString();
      document.getElementById('parentHash').textContent = header.parentHash.toString();
      document.getElementById('updated').textContent = new Date().toLocaleString();

      const extrinsics = signedBlock.block.extrinsics;
      document.getElementById('txCount').textContent = `${extrinsics.length} items`;

      const rows = document.getElementById('rows');
      if (!extrinsics.length) {
        rows.innerHTML = '<tr><td colspan="5" class="muted">No extrinsics in this block.</td></tr>';
        return;
      }

      rows.innerHTML = extrinsics.map((ex, i) => {
        const section = ex.method.section;
        const method = ex.method.method;
        const signer = ex.isSigned ? short(ex.signer.toString()) : '-';
        const success = findExtrinsicResult(allEvents, i);
        return `<tr><td>${i}</td><td>${section}</td><td>${method}</td><td class="muted">${signer}</td><td>${success}</td></tr>`;
      }).join('');
    }

    async function refreshLoop() {
      try {
        statusEl.textContent = 'Updating...';
        await fetchLatest();
        statusEl.textContent = 'Connected';
      } catch (e) {
        statusEl.textContent = `Error: ${e.message}`;
        document.getElementById('rows').innerHTML = `<tr><td colspan='5' class='muted'>${e.message}</td></tr>`;
      }
      left = 30;
    }

    setInterval(() => {
      left -= 1;
      if (left <= 0) refreshLoop();
      cdEl.textContent = String(Math.max(left, 0));
    }, 1000);

    document.getElementById('themeBtn').addEventListener('click', () => {
      const html = document.documentElement;
      html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    });

    refreshLoop();
  </script>
</body>
</html>
